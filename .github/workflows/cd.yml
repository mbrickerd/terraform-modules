name: CD

on:
  pull_request:
    branches: [develop, main]
    types: [closed]

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Detect changed modules
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            gcp:
              - 'modules/gcp/**'
            azure:
              - 'modules/azure/**'

      - name: Get GCP version
        if: steps.changes.outputs.gcp == 'true'
        id: gcp_version
        run: |
          VERSION=$(grep -oP 'module_version\s*=\s*"\K[^"]+' modules/gcp/versions.tf || echo "0.1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [ "${{ github.base_ref }}" != "main" ]; then
            echo "version=$VERSION-dev.$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          fi

      - name: Get Azure version
        if: steps.changes.outputs.azure == 'true'
        id: azure_version
        run: |
          VERSION=$(grep -oP 'module_version\s*=\s*"\K[^"]+' modules/azure/versions.tf || echo "0.1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [ "${{ github.base_ref }}" != "main" ]; then
            echo "version=$VERSION-dev.$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          fi

      - name: Package GCP module
        if: steps.changes.outputs.gcp == 'true'
        uses: thedoctor0/zip-release@master
        with:
          type: 'zip'
          filename: 'terraform-gcp-modules-${{ steps.gcp_version.outputs.version }}.zip'
          directory: 'modules/gcp'

      - name: Package Azure module
        if: steps.changes.outputs.azure == 'true'
        uses: thedoctor0/zip-release@master
        with:
          type: 'zip'
          filename: 'terraform-azure-modules-${{ steps.azure_version.outputs.version }}.zip'
          directory: 'modules/azure'

      - name: Publish GCP package
        if: steps.changes.outputs.gcp == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-gcp-modules-${{ steps.gcp_version.outputs.version }}
          path: modules/gcp/terraform-gcp-modules-${{ steps.gcp_version.outputs.version }}.zip
          retention-days: 90

      - name: Publish Azure package
        if: steps.changes.outputs.azure == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-azure-modules-${{ steps.azure_version.outputs.version }}
          path: modules/azure/terraform-azure-modules-${{ steps.azure_version.outputs.version }}.zip
          retention-days: 90

      - name: Create GCP release
        if: steps.changes.outputs.gcp == 'true' && github.base_ref == 'main'
        uses: softprops/action-gh-release@v1
        with:
          files: modules/gcp/terraform-gcp-modules-${{ steps.gcp_version.outputs.version }}.zip
          name: GCP Modules ${{ steps.gcp_version.outputs.version }}
          tag_name: gcp-${{ steps.gcp_version.outputs.version }}
          generate_release_notes: true

      - name: Create Azure release
        if: steps.changes.outputs.azure == 'true' && github.base_ref == 'main'
        uses: softprops/action-gh-release@v1
        with:
          files: modules/azure/terraform-azure-modules-${{ steps.azure_version.outputs.version }}.zip
          name: Azure Modules ${{ steps.azure_version.outputs.version }}
          tag_name: azure-${{ steps.azure_version.outputs.version }}
          generate_release_notes: true
